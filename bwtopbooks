<%@ Control Language="C#" AutoEventWireup="true" CodeFile="BWTopBooks.ascx.cs" Inherits="components_BWTopBooks" %>
<%@ Import Namespace="Bookswagon.Business.Utility" %>


<script type="text/javascript">
    var imageBaseUrl_Images200 = '<%= SystemConfig.GetImagePath("", "images200") %>';
    var imageBaseUrl_MainImages = '<%= SystemConfig.GetImagePath("", "mainimages") %>';
</script>

<style>
    img.newtrendstar {
        width: 10px !important;
        padding: 0px !important;
        border: none !important;
        height: auto !important;
        margin-top: -1px;
    }

    .averageratingbox {
        line-height: normal;
        display: inline-block;
        color: #fff;
        padding: 2px 4px 2px 6px;
        border-radius: 3px;
        font-weight: 500;
        font-size: 13px;
        vertical-align: middle;
        background-color: #388e3c;
    }

    .highrating { background-color: #388e3c; }
    .moderaterating { background-color: #ff9800; }
    .lowrating { background-color: #f44336; }

    #newtrend .rating-stars img {
        width: 15px !important;
        padding: 0px !important;
        border: none !important;
        height: auto;
    }

    .publisher-slider {
        position: relative;
    }

    .pattern9topBooks {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 10px;
    }

    .pattern9topBooks .item {
        display: block;
        flex: 0 0 auto;
    }

    @media (max-width: 419px) {
        .pattern9topBooks .item {
            display: flex;
            width: calc(33.33% - 7px);
        }
    }

    @media (min-width: 420px) and (max-width: 999px) {
        .pattern9topBooks .item {
            display: flex;
            width: calc(33.33% - 7px);
        }
    }

    @media (min-width: 1000px) and (max-width: 1152px) {
        .pattern9topBooks .item {
            display: inline-block;
            width: calc(14.28% - 9px);
            text-align: center;
        }
    }

    @media (min-width: 1153px) and (max-width: 1679px) {
        .pattern9topBooks .item {
            display: inline-block;
            width: calc(12.5% - 9px);
            text-align: center;
        }
    }

    @media (min-width: 1680px) {
        .pattern9topBooks .item {
            display: inline-block;
            width: calc(11.11% - 9px);
            text-align: center;
        }
    }

    .custom-owl-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        pointer-events: none;
        z-index: 10;
        width: 100%;
    }

    .custom-owl-nav .owl-prev,
    .custom-owl-nav .owl-next {
        background: #333 !important;
        color: #fff !important;
        border: none !important;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 28px !important;
        cursor: pointer;
        pointer-events: all;
        line-height: 46px;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .custom-owl-nav .owl-prev:hover,
    .custom-owl-nav .owl-next:hover {
        background: #555 !important;
        transform: scale(1.1);
        transition: all 0.2s ease;
    }

    .custom-owl-nav .disabled {
        opacity: 0.5;
        cursor: not-allowed !important;
        pointer-events: none;
    }

    .publisher-slider,
    .container.position-relative {
        position: relative;
        overflow: visible;
    }

    a.quick-view.themecolor {
        border: 1px solid #d51912;
        font-size: 13px;
        padding: 2px 8px;
        text-transform: uppercase;
        font-weight: 700;
        margin-bottom: 2px;
        position: relative;
        background: #fff;
        top: -31px;
        width: 123px;
        max-width: 90%;
        left: 50%;
        display: none;
        transform: translateX(-50%);
        cursor: pointer;
        text-align: center;
    }

    .themecolor {
        color: #d51912 !important;
    }

    .pattern9topBooks .card {
        position: relative;
        border: 1px solid #fff;
    }

    .pattern9topBooks .card:hover {
        border: 1px solid rgba(0,0,0,.16);
        box-shadow: 1px 1px 4px rgba(0,0,0,.16);
        border-radius: 3px;
    }

    .pattern9topBooks .card:hover a.quick-view {
        display: inline-block;
    }

    .loading-overlay {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        z-index: 999;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.active {
        display: flex;
    }
</style>

<div class="text-center mt-4">
    <h2><%=PromoTitle%></h2>
</div>

<div class="position-relative trendingSlider">
    <div class="loading-overlay" id="loadingOverlay_<%= this.ClientID %>">
        <img src="<%=SystemConfig.RootPath %>/images/dynamic/lazy-loading.gif" alt="Loading..." />
    </div>
    
    <div class="container">
        <div class="bookCarousel pattern9topBooks" id="bookCarousel_<%= this.ClientID %>">
            <!-- Books will be loaded here via AJAX -->
        </div>
    </div>
    
    <div id="lblPageInfo_<%= this.ClientID %>" class="mx-2 font-weight-bold text-center mt-3"></div>
    
    <div class="custom-owl-nav">
      <a href="#" id="btnPrev_<%= this.ClientID %>" class="owl-prev disabled">‚Äπ</a>
       <a href="#" id="btnNext_<%= this.ClientID %>" class="owl-next">‚Ä∫</a>
    </div>
</div>

<div class="col-sm-12 text-center pt-2 trend">
<a class="seeallbtn" href="<%=SystemConfig.RootPath %>/promo-best-seller/<%=MyCommon.ValidateUrlTitle(PromoTitle) %>/<%=PromoCode%>">SEE ALL</a>
</div>
<hr style="margin-top: 1rem!important" class="mb-0 mt-3 ml-0 mr-0">

<script type="text/javascript">


    var TrendingBooks_<%= this.ClientID %> = (function () {


        var currentPage = 1;
        var totalRecords = 0;
        var pageSize = 8;
        var isLoading = false;
        
        var promoCode = '<%=PromoCode%>';
        var rootPath = '<%=SystemConfig.RootPath %>';
        var currencySymbol = '<%=SiteConfig.CurrencySymbol %>';
        var isMobile = /Mobile|Android|iPhone/i.test(navigator.userAgent);

        var pageCache = {};


        function calculatePageSize() {
            var width = window.innerWidth;
            if (width < 420) return 7;
            else if (width < 1000) return 7;
            else if (width < 1153) return 7;
            else if (width < 1680) return 7;
            else return 8;
        }

        function showLoading(show) {
            var overlay = document.getElementById('loadingOverlay_<%= this.ClientID %>')
;
            if (show) {
                overlay.classList.add('active');
                isLoading = true;
            } else {
                overlay.classList.remove('active');
                isLoading = false;
            }
        }

       

        function loadBooks(page) {
            if (isLoading) return;
            console.log("üìò Inside loadBooks, page:", page, "promoCode:", promoCode);

            currentPage = page;

            if (pageCache[page]) {
                renderBooks(pageCache[page].books);
                totalRecords = pageCache[page].totalRecords;
                updatePagination();
                applyRatings();
                return;
            }

            showLoading(true);

            $.ajax({
                type: "GET",
                url: "/getSliderData.ashx",   // üëà match actual handler name!
                data: {
                    pageIndex: page,
                    pageSize: pageSize,
                    action: 'getTopBooks',
                    promoCode: promoCode
                },
                dataType: "json",
                success: function (response) {
                    console.log("‚úÖ Response received:", response);

                    // response is already a JS object, no need to parse .d
                    if (response.success) {
                        totalRecords = response.totalRecords;
                        pageCache[page] = {
                            books: response.books,
                            totalRecords: response.totalRecords
                        };
                        renderBooks(response.books);
                        updatePagination();
                        applyRatings();
                    } else {
                        console.warn("‚ö†Ô∏è No data found or success = false");
                    }

                    showLoading(false);
                },
                error: function (xhr, status, error) {
                    console.error('‚ùå Error loading books:', status, error);
                    console.error('Response text:', xhr.responseText);
                    showLoading(false);
                }
            });
        }



        function renderBooks(books) {
            var container = document.getElementById('bookCarousel_<%= this.ClientID %>');
            container.innerHTML = '';

            books.forEach(function (book) {
                // ‚úÖ Use the server-provided CloudFront URLs
                var imgPath = isMobile
                    ? imageBaseUrl_MainImages + '/productimages/mainimages/'
                    : imageBaseUrl_Images200 + '/productimages/images200/';

                var hasDiscount = parseFloat(book.Discount) > 0;
                var discountHtml = hasDiscount
                    ? '<div class="offer position-absolute" style="position:absolute; z-index:9">' +
                    Math.round(book.Discount) + '%</div>'
                    : '';

                var priceHtml = hasDiscount
                    ? '<span class="actualprice themecolor font-weight-bold">' + currencySymbol + book.ActualPrice + '</span> ' +
                    '<span class="initialprice"><del>' + currencySymbol + book.SalePrice + '</del></span>'
                    : '<span class="actualprice themecolor font-weight-bold">' + currencySymbol + book.ActualPrice + '</span>';

                var hasReviews = parseFloat(book.AvgReviewCount) > 0;
                var reviewHtml = hasReviews
                    ? '<span class="averageratingbox" data-rating="' + book.AvgReviewCount + '">' +
                    book.AvgReviewCount +
                    '<img class="newtrendstar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMyIgaGVpZ2h0PSIxMiI+PHBhdGggZmlsbD0iI0ZGRiIgZD0iTTYuNSA5LjQzOWwtMy42NzQgMi4yMy45NC00LjI2LTMuMjEtMi44ODMgNC4yNTQtLjQwNEw2LjUuMTEybDEuNjkgNC4wMSA0LjI1NC40MDQtMy4yMSAyLjg4Mi45NCA0LjI2eiIvPjwvc3ZnPg=="></span> ' +
                    '<span class="allreviewcount">(' + book.TotalReviewCount + ')</span>'
                    : '<span class="noreviewyet">No Review Yet</span>';

                var html =
                    '<div class="card align-items-center item">' +
                    discountHtml +
                    '<a href="' + rootPath + '/book/' + book.TitleUrl + '/' + book.ISBN13 + '">' +
                    '<img class="card-img-top" src="' + imgPath + book.ImageLocation + '" ' +
                    'alt="' + book.Title + '" height="200px" width="125px" />' +
                    '</a>' +
                    '<div class="card-body bookbrief">' +
                    '<a class="quick-view themecolor" data-toggle="modal" data-target="#quickviewmodal" ' +
                    'data-id="' + book.ProductId + '">Quick View</a>' +
                    '<p class="card-text text-center">' +
                    '<span class="booktitle font-weight-bold">' + book.Title + '</span>' +
                    '</p>' +
                    '<p><span class="author authortextcolor">' + book.AuthorName + '</span></p>' +
                    '<div class="d-block">' +
                    '<span class="rating-stars-container d-block" style="padding-left: 0px">' +
                    '<span class="rating-stars rating-stars-offslider position-relative" aria-hidden="true">' +
                    '<img src="../../images/svg/graystar.svg">'.repeat(5) +
                    '<span class="rating-stars rating-stars-onslider position-absolute" data-rating="' + book.AvgReviewCount + '">' +
                    '<img src="../../images/svg/redstar.svg">'.repeat(5) +
                    '</span>' +
                    '</span>' +
                    '</span>' +
                    reviewHtml +
                    '</div>' +
                    '<p class="text-center">' + priceHtml + '</p>' +
                    '</div>' +
                    '</div>';

                container.innerHTML += html;
            });
        }



        function applyRatings() {
            $('.pattern9topBooks .card').each(function () {
                var $card = $(this);
                var $ratingBox = $card.find('.averageratingbox');
                var $ratingBar = $card.find('.rating-stars-onslider');

                var rating = parseFloat($ratingBar.attr('data-rating'));

                if (rating > 3) $ratingBox.addClass('highrating');
                else if (rating < 2) $ratingBox.addClass('lowrating');
                else $ratingBox.addClass('moderaterating');

                var percentage = rating * 20;
                var decimal = rating % 1;

                if (decimal > 0.6) percentage -= 3;
                else if (decimal < 0.3) percentage += 2;

                $ratingBar.css('width', percentage + '%');
            });
        }

        function updatePagination() {
            var totalPages = Math.ceil(totalRecords / pageSize);
            var pageInfo = 'Page ' + currentPage + ' of ' + totalPages;
            document.getElementById('lblPageInfo_<%= this.ClientID %>').textContent = pageInfo;

            var prevBtn = document.getElementById('btnPrev_<%= this.ClientID %>')
            var nextBtn = document.getElementById('btnNext_<%= this.ClientID %>')

            if (currentPage > 1) {
                prevBtn.classList.remove('disabled');
            } else {
                prevBtn.classList.add('disabled');
            }

            if (currentPage < totalPages) {
                nextBtn.classList.remove('disabled');
            } else {
                nextBtn.classList.add('disabled');
            }
        }

        function init() {
            pageSize = calculatePageSize();
            loadBooks(1);

            document.getElementById('btnPrev_<%= this.ClientID %>').addEventListener('click', function (e) {
                e.preventDefault();
                if (currentPage > 1) {
                    loadBooks(currentPage - 1);
                }
            });

            document.getElementById('btnNext_<%= this.ClientID %>').addEventListener('click', function (e) {
                e.preventDefault();
                var totalPages = Math.ceil(totalRecords / pageSize);
                if (currentPage < totalPages) {
                    loadBooks(currentPage + 1);
                }
            });

            var resizeTimer;
            window.addEventListener('resize', function () {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function () {
                    var newPageSize = calculatePageSize();
                    if (newPageSize !== pageSize) {
                        pageSize = newPageSize;
                        loadBooks(1);
                        pageCache = {};

                    }
                }, 300);
            });
        }

        return {
            init: init
        };
    })();

    $(document).ready(function () {
        TrendingBooks_<%= this.ClientID %>.init();
});
</script>ction (i) {
            $(this).delay(200 * i).fadeTo(400, 1); // fade in one by one
        });
        -->
});
</script>ction (i) {
            $(this).delay(200 * i).fadeTo(400, 1); // fade in one by one
        });
        -->
});
</script>
